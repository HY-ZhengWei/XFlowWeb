<!DOCTYPE html>
<html>
<head>

	<title>工作流</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	
	<script type="text/javascript" charset="utf-8" src="../../d3/d3.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../jquery/jquery.min.js" ></script>
	<script type="text/javascript" charset="utf-8" src="../../jquery/jquery-ui.min.js"></script>
	
	<link rel="stylesheet" href="../../jquery/jquery-ui.min.css" />
	
	<style type="text/css">
	body {
	  font-family: 'Open Sans', sans-serif;
	  font-size: 12px;
	  font-weight: 400;
	  background-color: #fff;
	}
	</style>
	
</head>
<body>

	<svg width="100%" height="900" version="1.1" xmlns="http://www.w3.org/2000/svg">
	
		<defs>
		
			<filter id="shadow">
		        <feGaussianBlur in="SourceAlpha" stdDeviation="1" result="blur"></feGaussianBlur>
		        <feOffset in="blur" dx="1" dy="1" result="offset"></feOffset>
		        <feMerge>
		        <feMergeNode in="offset"></feMergeNode>
		        <feMergeNode in="SourceGraphic"></feMergeNode>
		        </feMerge>
	        </filter>
	        
	        <marker id="arrowTo" 
					markerUnits="strokerWidth"
					markerWidth="6"
					markerHeight="6"
					viewBox="0 0 12 12"
					refX="9"
					refY="6"
					orient="auto">
				<path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill:#6AB975;" />
			</marker>
			
			<marker id="arrowTo_Reject" 
					markerUnits="strokerWidth"
					markerWidth="6"
					markerHeight="6"
					viewBox="0 0 12 12"
					refX="9"
					refY="6"
					orient="auto">
				<path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill:#FF4444;" />
			</marker>
			
			<marker id="arrowToFirebox" 
					markerUnits="strokerWidth"
					markerWidth="18"
					markerHeight="18"
					viewBox="0 0 12 12"
					refX="9"
					refY="6"
					orient="auto">
				<path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill:#6AB975;" />
			</marker>
			
			<marker id="arrowToFirebox_Reject" 
					markerUnits="strokerWidth"
					markerWidth="18"
					markerHeight="18"
					viewBox="0 0 12 12"
					refX="9"
					refY="6"
					orient="auto">
				<path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill:#FF4444;" />
			</marker>
    		
		</defs>
	
	</svg>
	
	<script type="text/javascript">
	
	var N         = {width:130 ,height:40 ,lineWidth:1 ,flagWidth:18 };
	var Colors    = {backgroudColor:"white" ,routeColor:"#6AB975" ,routeRejectColor:"#FF4444"}; 
	var v_SVG     = d3.select("body").select("svg");
	var v_Datas   = [{id:"N1" ,name:"选型申请" ,backgroudColor:"white" ,flagColor:"#6AB975" ,lineColor:"black"}
                    ,{id:"N2" ,name:"审批选型" ,backgroudColor:"white" ,flagColor:"#FF4444" ,lineColor:"black"}
                    ,{id:"N3" ,name:"选型受理" ,backgroudColor:"white" ,flagColor:"#5687D1" ,lineColor:"black"}];

	var v_Routes  = [{"id":"L1-2" ,"from":"N1" ,"to":"N2" ,"type":"转派"}
	                ,{"id":"L1-3" ,"from":"N1" ,"to":"N3" ,"type":"转派"}
	                ,{"id":"L2-3" ,"from":"N2" ,"to":"N3" ,"type":"驳回"}];

	var v_RouteMap  = makeRouteMap (v_Routes);
	var v_RouteRefs = makeRouteRefs(v_Routes);
	var v_XOffset = 0;
	var v_YOffset = 0;
	var v_Drag    = d3.drag()                                // 创建一个拖曳行为
    .on("start" ,function()
    {
		var v_XY = getGXY(d3.select(this));
		v_XOffset = d3.event.x - v_XY[0];
		v_YOffset = d3.event.y - v_XY[1];
    })
    .on("drag" ,function(d)
    {
    	var v_G        = d3.select(this);
    	var v_NodeID   = v_G.attr("id");
    	var v_RouteIDs = v_RouteRefs[v_NodeID];
    	
    	v_G.attr("transform" ,"translate(" + (d3.event.x - v_XOffset) + "," + (d3.event.y - v_YOffset) + ")");
    	
    	for (var i=0; i<v_RouteIDs.length; i++)
   		{
    		var v_RouteData = v_RouteMap.get(v_RouteIDs[i]);
    		var v_RounteObj = d3.select("#" + v_RouteData.id);
    		var v_FromG     = d3.select("#" + v_RouteData.from);
    		var v_ToG       = d3.select("#" + v_RouteData.to);
    		
    		v_RounteObj.attr("points" ,calcRouteXY(v_FromG ,v_ToG));
   		}
    });
	
	
	
	/**
	 * 绘制流程节点
	 *
	 * @author      ZhengWei(HY)
	 * @createDate  2018-09-09
	 * @version     v1.0
	 */
	function drawNode(i_G ,i_Data)
	{
		var v_NodeRect = i_G.append("rect")
		.attr("width"        ,N.width)
		.attr("height"       ,N.height)
		.attr("stroke-width" ,N.lineWidth)
		.attr("id"           ,"NGR" + i_Data.id)
		.attr("stroke"       ,i_Data.lineColor)
		.attr("fill"         ,i_Data.backgroudColor);
		
		var v_NodeFlag = i_G.append("polygon")
		.attr("stroke-width" ,N.lineWidth)
		.attr("id"           ,"NGF" + i_Data.id)
		.attr("stroke"       ,i_Data.lineColor)
		.attr("fill"         ,i_Data.flagColor)
		.attr("points" ,function()
		{
			var v_StartX = 7;
			return v_StartX + ",0 "
			     + (v_StartX + N.flagWidth) + ",0 "
			     + (v_StartX + N.flagWidth) + "," + N.height + " "
			     + (v_StartX + N.flagWidth / 2) + "," + (N.height - N.flagWidth / 2) + " "
			     + v_StartX + "," + N.height;
		});
		
		var v_NodeName = i_G.append("text")
		.attr("id"          ,"NGT" + i_Data.id)
		.attr("x"           ,N.width  / 2)
		.attr("y"           ,N.height / 2)
		.attr("dy"          ,"0.35em")
		.attr("text-anchor" ,"middle")
		.attr("font-weight" ,"bold")
		.attr("fill"        ,"black")
		.text(i_Data.name);
	}
	
	
	
	/**
	 * 用路由数组生成路由Map，可通过路由ID定位路由信息。
	 *    Map.key   为路由ID
	 *    Map.value 为路由信息
	 *
	 * @author      ZhengWei(HY)
	 * @createDate  2018-10-23
	 * @version     v1.0
	 */
	function makeRouteMap(i_Routes)
	{
		var v_Map = d3.map();
		
		for (var i=0; i<i_Routes.length; i++)
		{
			v_Map.set(i_Routes[i].id ,i_Routes[i]);
		}
		
		return v_Map;
	}
	
	
	
	/**
	 * 用路由数组生成路由节点关系，可通过节点ID定位到所有的路由ID。
	 *    
	 *    返回结构为：Object.节点ID1.["路由ID1-2" ,"路由ID1-3"]
	 *                    .节点ID2.["路由ID1-2" ,"路由ID2-3"]
	 *                    .节点ID3.["路由ID1-3" ,"路由ID2-3"]
	 *
	 * @author      ZhengWei(HY)
	 * @createDate  2018-10-23
	 * @version     v1.0
	 */
	function makeRouteRefs(i_Routes)
	{
		var v_Refs = new Object();
		
		for (var i=0; i<i_Routes.length; i++)
		{
			if ( v_Refs[i_Routes[i].from] == null )
			{
				v_Refs[i_Routes[i].from] = new Array();
			}
			if ( v_Refs[i_Routes[i].to] == null )
			{
				v_Refs[i_Routes[i].to] = new Array();
			}
			
			v_Refs[i_Routes[i].from].push(i_Routes[i].id);
			v_Refs[i_Routes[i].to  ].push(i_Routes[i].id);
		}
		
		return v_Refs;
	}
	
	
	
	/**
	 * 获取G元素的XY坐标位置
	 * 
	 * @author      ZhengWei(HY)
	 * @createDate  2018-10-23
	 * @version     v1.0
	 */
	function getGXY(i_G)
	{
		return i_G.attr("transform").replace("translate(" ,"").replace(")" ,"").split(",");
	}
	
	
	
	/**
	 * 计算两元素XY坐标位置的关系
	 *
	 * 返回以元素A为中心点，元素B所在的位置（E东、W西、S南、N北、ES东南。。。）
	 * 
	 * @author      ZhengWei(HY)
	 * @createDate  2018-10-23
	 * @version     v1.0
	 *
	 * @param i_X1  A元素的X坐标
	 * @param i_Y1  A元素的Y坐标
	 * @param i_X2  B元素的X坐标
	 * @param i_Y2  B元素的Y坐标
	 */
	function calcPositionRelation(i_X1 ,i_Y1 ,i_X2 ,i_Y2 ,i_AWidth ,i_AHeight ,i_BWidth ,i_BHeight)
	{
		var v_Position  = "";  /* 以元素A为中心点，元素B所在的位置（E东、W西、S南、N北、ES东南。。。） */
		var v_TopBottom = 0;   /* 两元素上下空隙。大于等于0时，为真空隙。负值时，两元素上下有重叠的坐标 */
		var v_LeftRight = 0;   /* 两元素左右空隙。大于等于0时，为真空隙。负值时，两元素左右有重叠的坐标 */
		
		/* AB两元素，垂直上下关系，A在上，B在下 */
		if ( i_X1 == i_X2 && i_Y1 < i_Y2 )
		{
			v_Position  = "S";
			v_TopBottom = i_Y2 - (i_Y1 + i_AHeight);
			v_LeftRight = 0;
		}
		/* AB两元素，垂直上下关系，A在下，B在上 */
		else if ( i_X1 == i_X2 && i_Y1 > i_Y2 )
		{
			v_Position  = "N";
			v_TopBottom = i_Y1 - (i_Y2 + i_BHeight);
			v_LeftRight = 0;
		}
		/* AB两元素，水平左右关系，A在左，B在右 */
		else if ( i_X1 < i_X2 && i_Y1 == i_Y2 )
		{
			v_Position  = "E";
			v_TopBottom = 0;
			v_LeftRight = i_X2 - (i_X1 + i_AWidth);
		}
		/* AB两元素，水平左右关系，A在右，B在左 */
		else if ( i_X1 > i_X2 && i_Y1 == i_Y2 )
		{
			v_Position  = "W";
			v_TopBottom = 0;
			v_LeftRight = i_X1 - (i_X2 + i_BWidth);
		}
		/* AB两元素，B在A的左下方 */
		else if ( i_X1 > i_X2 && i_Y1 < i_Y2 )
		{
			v_Position  = "WS";
			v_TopBottom = i_Y2 - (i_Y1 + i_AHeight);
			v_LeftRight = i_X1 - (i_X2 + i_BWidth);
		}
		/* AB两元素，B在A的右下方 */
		else if ( i_X1 < i_X2 && i_Y1 < i_Y2 )
		{
			v_Position  = "ES";
			v_TopBottom = i_Y2 - (i_Y1 + i_AHeight);
			v_LeftRight = i_X2 - (i_X1 + i_AWidth);
		}
		/* AB两元素，B在A的左上方 */
		else if ( i_X1 > i_X2 && i_Y1 > i_Y2 )
		{
			v_Position  = "WN";
			v_TopBottom = i_Y1 - (i_Y2 + i_BHeight);
			v_LeftRight = i_X1 - (i_X2 + i_BWidth);
		}
		/* AB两元素，B在A的右上方 */
		else if ( i_X1 < i_X2 && i_Y1 > i_Y2 )
		{
			v_Position  = "EN";
			v_TopBottom = i_Y1 - (i_Y2 + i_BHeight);
			v_LeftRight = i_X2 - (i_X1 + i_AWidth);
		}
		
		return {"position":v_Position ,"topBottom":v_TopBottom ,"leftRight":v_LeftRight};
	}
	
	
	
	function calcRouteXY(i_FromG ,i_ToG)
	{
		var v_FromXY = getGXY(i_FromG);
		var v_ToXY   = getGXY(i_ToG);
		var v_MidAXY = null;
		var v_MidBXY = null;
		var v_PR     = calcPositionRelation(Number(v_FromXY[0])
				                           ,Number(v_FromXY[1])
				                           ,Number(v_ToXY[0])
				                           ,Number(v_ToXY[1])
				                           ,N.width
				                           ,N.height
				                           ,N.width
				                           ,N.height);
		
		if ( v_PR.position == "E" )
		{
			v_FromXY[0] = Number(v_FromXY[0]) + N.width;
			v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
			
			v_ToXY[0] = Number(v_ToXY[0]) + 0;
			v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
 		}
		else if ( v_PR.position == "W" )
		{
			v_FromXY[0] = Number(v_FromXY[0]) + 0;
			v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
			
			v_ToXY[0] = Number(v_ToXY[0]) + N.width;
			v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
		}
		else if ( v_PR.position == "N" )
		{
			v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
			v_FromXY[1] = Number(v_FromXY[1]) + 0;
			
			v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
			v_ToXY[1] = Number(v_ToXY[1]) + N.height;
		}
		else if ( v_PR.position == "S" )
		{
			v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
			v_FromXY[1] = Number(v_FromXY[1]) + N.height;
			
			v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
			v_ToXY[1] = Number(v_ToXY[1]) + 0;
		}
		else if ( v_PR.position == "EN" )
		{
			/* B全部在A的右边。B全部在A的上边 */
			if ( v_PR.leftRight >= 0 && v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + N.width;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0]   = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1]   = Number(v_ToXY[1]) + N.height;
				
				v_MidAXY    = new Array();
				v_MidAXY[0] = v_ToXY[0];
				v_MidAXY[1] = v_FromXY[1];
			}
			else if ( v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
				v_FromXY[1] = Number(v_FromXY[1]) + 0;
				
				v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1] = Number(v_ToXY[1]) + N.height;
			}
			else if ( v_PR.leftRight >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + N.width;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0] = Number(v_ToXY[0]) + 0;
				v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
			}
		}
		else if ( v_PR.position == "ES" )
		{
			/* B全部在A的右边。B全部在A的下边 */
			if ( v_PR.leftRight >= 0 && v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
				v_FromXY[1] = Number(v_FromXY[1]) + N.height;
				
				v_ToXY[0]   = Number(v_ToXY[0]) + 0;
				v_ToXY[1]   = Number(v_ToXY[1]) + (N.height / 2);
				
				v_MidAXY    = new Array();
				v_MidAXY[0] = v_FromXY[0];
				v_MidAXY[1] = v_ToXY[1];
			}
			else if ( v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
				v_FromXY[1] = Number(v_FromXY[1]) + N.height;
				
				v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1] = Number(v_ToXY[1]) + 0;
			}
			else if ( v_PR.leftRight >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + N.width;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0] = Number(v_ToXY[0]) + 0;
				v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
			}
		}
		else if ( v_PR.position == "WN" )
		{
			/* B全部在A的左边。B全部在A的上边 */
			if ( v_PR.leftRight >= 0 && v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + 0;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0]   = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1]   = Number(v_ToXY[1]) + N.height;
				
				v_MidAXY    = new Array();
				v_MidAXY[0] = v_ToXY[0];
				v_MidAXY[1] = v_FromXY[1];
			}
			else if ( v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
				v_FromXY[1] = Number(v_FromXY[1]) + 0;
				
				v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1] = Number(v_ToXY[1]) + N.height;
			}
			else if ( v_PR.leftRight >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + 0;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0] = Number(v_ToXY[0]) + N.width;
				v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
			}
		}
		else if ( v_PR.position == "WS" )
		{
			/* B全部在A的左边。B全部在A的下边 */
			if ( v_PR.leftRight >= 0 && v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + 0;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0]   = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1]   = Number(v_ToXY[1]) + 0;
				
				v_MidAXY    = new Array();
				v_MidAXY[0] = v_ToXY[0];
				v_MidAXY[1] = v_FromXY[1];
			}
			else if ( v_PR.topBottom >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + (N.width / 2);
				v_FromXY[1] = Number(v_FromXY[1]) + N.height;
				
				v_ToXY[0] = Number(v_ToXY[0]) + (N.width / 2);
				v_ToXY[1] = Number(v_ToXY[1]) + 0;
			}
			else if ( v_PR.leftRight >= 0 )
			{
				v_FromXY[0] = Number(v_FromXY[0]) + 0;
				v_FromXY[1] = Number(v_FromXY[1]) + (N.height / 2);
				
				v_ToXY[0] = Number(v_ToXY[0]) + N.width;
				v_ToXY[1] = Number(v_ToXY[1]) + (N.height / 2);
			}
		}
		
		if ( v_MidAXY == null )
		{
			return v_FromXY[0] + "," + v_FromXY[1] + " " + v_ToXY[0] + "," + v_ToXY[1]; 
		}
		else if ( v_MidBXY == null )
		{
			return v_FromXY[0] + "," + v_FromXY[1] + " " + v_MidAXY[0] + "," + v_MidAXY[1] + " " + v_ToXY[0] + "," + v_ToXY[1]; 
		}
		
	}
	
	
	
	v_SVG.selectAll("g").data(v_Datas)
	.enter()
	.append("g")
	.attr("id" ,function(d ,i)
	{
		return d.id; 
	})
	.attr("transform", function(d ,i) 
	{
	    return "translate(" + (N.width * i * 2 + N.width) + "," + (N.height * i * 3 + N.height) + ")";
	})
	.attr("filter" ,"url(#shadow)")
	.call(v_Drag);
	
	v_SVG.selectAll("g").data(v_Datas)
	.each(function(d ,i)
	{
		drawNode(d3.select(this) ,d);
	});
	
	
	
	v_SVG.selectAll("polyline").data(v_Routes)
	.enter()
	.append("polyline")
	.attr("id" ,function(d ,i)
	{
		return d.id;	
	})
	.attr("points" ,function(d ,i)
	{
		var v_FromG  = d3.select("#" + d.from);
		var v_ToG    = d3.select("#" + d.to);
		
		return calcRouteXY(v_FromG ,v_ToG);
	})
	.attr("fill" ,"#00000000")
	.attr("stroke-width" ,3)
	.attr("stroke" ,function(d ,i)
	{
		if ( d.type == "驳回" )
		{
			return Colors.routeRejectColor;
		}
		else
		{
			return Colors.routeColor;
		}
	})
	.attr("stroke-dasharray" ,function(d ,i)
	{
		if ( d.type == "驳回" )
		{
			return "5,2";
		}
		else
		{
			return "1,0";
		}
	})
	.attr("marker-end" ,function(d ,i)
	{
		var v_Flag = "";
		if ( d.type == "驳回" )
		{
			v_Flag = "_Reject";
		}
		
		var v_UserAgent = navigator.userAgent.toLowerCase();
		if ( v_UserAgent.indexOf("firefox") >= 0 ) 
		{
			return "url(#arrowToFirebox" + v_Flag + ")";
		}
		else
		{
			console.log(d.type + v_Flag);
			return "url(#arrowTo" + v_Flag + ")";
		}
	});
	
	</script>
	
</body>
</html>